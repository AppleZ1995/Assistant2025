<% include partials/header %>
      <div class="row">
        <div class="col-md-8">
          <!-- Quick Actions removed per request -->

          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Summary</h5>
              <p class="mb-0"><strong>Total balance:</strong> <span class="fw-bold"><%= typeof total !== 'undefined' ? total : 0 %></span></p>
            </div>
          </div>

          <div id="recent-records" class="card">
            <div class="card-body">
              <h5 class="card-title">Recent Records</h5>
              <% if (!recent || recent.length === 0) { %>
                <p>No recent records.</p>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr><th>Date</th><th>Title</th><th>Category</th><th>Amount</th><th>Type</th></tr>
                    </thead>
                    <tbody>
                      <% recent.forEach(function(it) { %>
                        <tr>
                          <td><%= new Date(it.date).toLocaleString() %></td>
                          <td><%= it.title %></td>
                          <td><%= it.category || '' %></td>
                          <td><%= it.amount %></td>
                          <td><span class="badge <%= it.type === 'income' ? 'bg-success' : 'bg-danger' %>"><%= it.type %></span></td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="quick-add" class="card">
            <div class="card-body">
              <h5 class="card-title">Add Quick Record</h5>
              <form method="post" action="/expenses">
                <div class="mb-3">
                  <label class="form-label">Title</label>
                  <input name="title" required class="form-control" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Amount</label>
                  <input name="amount" type="number" step="0.01" required class="form-control" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Type</label>
                  <select name="type" class="form-select">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Note</label>
                  <input name="note" class="form-control" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Category</label>
                  <input name="category" class="form-control" placeholder="e.g. Food, Travel, Salary" />
                </div>
                <button class="btn btn-primary" type="submit">Add</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container py-4">
      <div class="row">
        <div class="col-md-8">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Trends (last 30 days)</h5>
              <div style="height:260px;">
                <canvas id="lineChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">By Type</h5>
              <div style="height:260px;">
                <canvas id="doughnutChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.addEventListener('load', async function() {
        try {
          const resp = await fetch('/api/v1/expenses/summary');
          if (!resp.ok) throw new Error('Failed to load summary');
          const data = await resp.json();

          const daily = data.daily || [];
          const labels = daily.map(r => r.d);
          const values = daily.map(r => Number(r.total) || 0);

          const ctx = document.getElementById('lineChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Daily total',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
              }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });

          const types = data.types || [];
          const tlabels = types.map(t => t.type);
          const tvalues = types.map(t => Number(t.total) || 0);
          const tctx = document.getElementById('doughnutChart').getContext('2d');
          new Chart(tctx, {
            type: 'doughnut',
            data: {
              labels: tlabels,
              datasets: [{ data: tvalues, backgroundColor: ['#dc3545', '#198754', '#0d6efd', '#ffc107'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        } catch (e) {
          console.error('Chart error', e);
        }
      });
    </script>

    <!-- Calendar section -->
    <div class="container py-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Calendar (timeline)</h5>
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <script>
      window.addEventListener('load', async function() {
        try {
          // initialize FullCalendar
          const calendarEl = document.getElementById('calendar');
          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            height: 600,
            events: '/api/v1/expenses/events',
            eventDidMount: function(info) {
              // small badge with amount
              // FullCalendar renders title, we already include amount in title
            }
          });
          calendar.render();
        } catch (e) {
          console.error('Calendar error', e);
        }
      });
    </script>

<% include partials/footer %>
